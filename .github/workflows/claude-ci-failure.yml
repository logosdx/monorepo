name: Claude CI Failure Analysis

on:
  workflow_run:
    workflows: ["CI", "Publish", "Docs"]
    types: [completed]
  workflow_dispatch:
    inputs:
      run_id:
        description: "Failed workflow run ID to analyze (get from Actions URL)"
        required: true
        type: string
      test_mode:
        description: "Skip Claude analysis, just test Slack"
        required: false
        type: boolean
        default: false

jobs:
  analyze-failure:
    # Skip changesets version releases (triggered by github-actions bot on Version Packages commits)
    if: |
      (github.event.workflow_run.conclusion == 'failure' || github.event_name == 'workflow_dispatch') &&
      github.event.workflow_run.actor.login != 'github-actions[bot]' &&
      !startsWith(github.event.workflow_run.head_commit.message, 'Version Packages')
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write
      actions: read
      issues: write
      id-token: write
    steps:
      - name: Checkout repository
        uses: actions/checkout@v6
        with:
          fetch-depth: 1

      - name: Get Run Info
        id: run-info
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            RUN_ID="${{ inputs.run_id }}"
            RUN_INFO=$(gh run view "$RUN_ID" --json name,headBranch,headSha,url,actor)
            echo "run_id=$RUN_ID" >> $GITHUB_OUTPUT
            echo "workflow_name=$(echo "$RUN_INFO" | jq -r '.name')" >> $GITHUB_OUTPUT
            echo "branch=$(echo "$RUN_INFO" | jq -r '.headBranch')" >> $GITHUB_OUTPUT
            echo "commit=$(echo "$RUN_INFO" | jq -r '.headSha')" >> $GITHUB_OUTPUT
            echo "run_url=$(echo "$RUN_INFO" | jq -r '.url')" >> $GITHUB_OUTPUT
            echo "actor=$(echo "$RUN_INFO" | jq -r '.actor.login // .actor')" >> $GITHUB_OUTPUT
          else
            echo "run_id=${{ github.event.workflow_run.id }}" >> $GITHUB_OUTPUT
            echo "workflow_name=${{ github.event.workflow_run.name }}" >> $GITHUB_OUTPUT
            echo "branch=${{ github.event.workflow_run.head_branch }}" >> $GITHUB_OUTPUT
            echo "commit=${{ github.event.workflow_run.head_sha }}" >> $GITHUB_OUTPUT
            echo "run_url=${{ github.event.workflow_run.html_url }}" >> $GITHUB_OUTPUT
            echo "actor=${{ github.event.workflow_run.actor.login }}" >> $GITHUB_OUTPUT
          fi

      - name: Claude CI Failure Analysis
        if: ${{ inputs.test_mode != true }}
        id: claude-analysis
        uses: anthropics/claude-code-action@v1
        with:
          anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}
          use_sticky_comment: true
          additional_permissions: |
            actions: read
          prompt: |
            REPO: ${{ github.repository }}
            WORKFLOW: ${{ steps.run-info.outputs.workflow_name }}
            RUN_ID: ${{ steps.run-info.outputs.run_id }}
            RUN_URL: ${{ steps.run-info.outputs.run_url }}
            BRANCH: ${{ steps.run-info.outputs.branch }}
            COMMIT: ${{ steps.run-info.outputs.commit }}
            TRIGGERED_BY: ${{ steps.run-info.outputs.actor }}

            IMPORTANT: When tagging users, ONLY use @${{ steps.run-info.outputs.actor }} (the user who triggered the workflow).
            Do NOT invent or guess usernames. Do NOT tag @dralonso or any other username.

            A CI workflow has failed. Analyze the failure and report findings.

            ## Step 1: Get Failed Logs
            Run: `gh run view ${{ steps.run-info.outputs.run_id }} --log-failed`

            ## Step 2: Analyze the Failure
            Determine:
            - Which step(s) failed
            - Root cause of the failure (test failure, build error, lint issue, etc.)
            - Whether this is a flaky test or legitimate failure
            - Specific file(s) and line(s) causing the issue if identifiable

            ## Step 3: Suggest Fix
            Provide actionable suggestions to fix the issue.

            ## Step 4: Write Slack Summary
            Create a file at /tmp/slack_summary.txt containing a brief 2-3 sentence summary of:
            - What failed (workflow name, step)
            - Why it failed (root cause)
            - How to fix it

            Keep it concise for Slack. No markdown headers, just plain text.
            Do NOT use quotes, colons, or special characters that could break JSON.

          claude_args: |
            --max-turns 15
            --allowedTools "Bash(gh run view:*),Bash(gh run list:*),Read,Glob,Grep,Write"

      - name: Read Claude Summary and Build Payload
        id: slack-payload
        run: |
          WORKFLOW="${{ steps.run-info.outputs.workflow_name }}"
          BRANCH="${{ steps.run-info.outputs.branch }}"
          RUN_URL="${{ steps.run-info.outputs.run_url }}"

          if [ -f /tmp/slack_summary.txt ]; then
            SUMMARY=$(cat /tmp/slack_summary.txt | tr '\n' ' ' | sed 's/"/\\"/g' | sed "s/'/\\'/g" | cut -c1-500)
          else
            SUMMARY="CI failure in ${WORKFLOW} on branch ${BRANCH}. Check the workflow run for details."
          fi

          cat > /tmp/slack_payload.json << EOF
          {
            "blocks": [
              {
                "type": "header",
                "text": {
                  "type": "plain_text",
                  "text": "ðŸ”´ CI Pipeline Failed",
                  "emoji": true
                }
              },
              {
                "type": "section",
                "fields": [
                  {
                    "type": "mrkdwn",
                    "text": "*Workflow:*\n${WORKFLOW}"
                  },
                  {
                    "type": "mrkdwn",
                    "text": "*Branch:*\n${BRANCH}"
                  }
                ]
              },
              {
                "type": "section",
                "text": {
                  "type": "mrkdwn",
                  "text": "*Claude's Analysis:*\n${SUMMARY}"
                }
              },
              {
                "type": "actions",
                "elements": [
                  {
                    "type": "button",
                    "text": {
                      "type": "plain_text",
                      "text": "View Failed Run",
                      "emoji": true
                    },
                    "url": "${RUN_URL}",
                    "style": "danger"
                  },
                  {
                    "type": "button",
                    "text": {
                      "type": "plain_text",
                      "text": "View Repository",
                      "emoji": true
                    },
                    "url": "${{ github.server_url }}/${{ github.repository }}"
                  }
                ]
              }
            ]
          }
          EOF

          cat /tmp/slack_payload.json
          echo "payload_file=/tmp/slack_payload.json" >> $GITHUB_OUTPUT

      - name: Send Slack Notification
        uses: slackapi/slack-github-action@v2.1.1
        with:
          webhook: ${{ secrets.SLACK_WEBHOOK_URL }}
          webhook-type: incoming-webhook
          payload-file-path: ${{ steps.slack-payload.outputs.payload_file }}
