name: Claude CI Failure Analysis

on:
  workflow_run:
    workflows: ["CI", "Publish", "Docs"]
    types: [completed]

jobs:
  analyze-failure:
    if: ${{ github.event.workflow_run.conclusion == 'failure' }}
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write
      actions: read
      issues: write
      id-token: write
    steps:
      - name: Checkout repository
        uses: actions/checkout@v6
        with:
          fetch-depth: 1

      - name: Claude CI Failure Analysis
        id: claude-analysis
        uses: anthropics/claude-code-action@v1
        with:
          anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}
          use_sticky_comment: true
          additional_permissions: |
            actions: read
          prompt: |
            REPO: ${{ github.repository }}
            WORKFLOW: ${{ github.event.workflow_run.name }}
            RUN_ID: ${{ github.event.workflow_run.id }}
            RUN_URL: ${{ github.event.workflow_run.html_url }}
            BRANCH: ${{ github.event.workflow_run.head_branch }}
            COMMIT: ${{ github.event.workflow_run.head_sha }}
            PR_NUMBER: ${{ github.event.workflow_run.pull_requests[0].number }}

            A CI workflow has failed. Analyze the failure and report findings.

            ## Step 1: Get Failed Logs
            Run: `gh run view ${{ github.event.workflow_run.id }} --log-failed`

            ## Step 2: Analyze the Failure
            Determine:
            - Which step(s) failed
            - Root cause of the failure (test failure, build error, lint issue, etc.)
            - Whether this is a flaky test or legitimate failure
            - Specific file(s) and line(s) causing the issue if identifiable

            ## Step 3: Suggest Fix
            Provide actionable suggestions to fix the issue.

            ## Step 4: Post Comment
            If this is associated with a PR (PR_NUMBER is not empty):
              Post a comment on the PR using `gh pr comment $PR_NUMBER`

            If this is a branch push without PR:
              Create an issue using `gh issue create`

            The comment/issue MUST:
            - Start with: `## ðŸ”´ CI Failure Analysis`
            - Tag the maintainer: @dralonso
            - Include the workflow name and link to the failed run
            - Summarize the failure cause
            - Provide suggested fix
            - End with: `_Analysis generated by Claude Code_`

            ## Step 5: Write Slack Summary
            Create a file at /tmp/slack_summary.txt containing a brief 2-3 sentence summary of:
            - What failed (workflow name, step)
            - Why it failed (root cause)
            - How to fix it

            Keep it concise for Slack. No markdown headers, just plain text.

          claude_args: |
            --max-turns 15
            --allowedTools "Bash(gh run view:*),Bash(gh run list:*),Bash(gh pr comment:*),Bash(gh issue create:*),Read,Glob,Grep,Write"

      - name: Read Claude Summary
        id: read-summary
        run: |
          if [ -f /tmp/slack_summary.txt ]; then
            SUMMARY=$(cat /tmp/slack_summary.txt)
            echo "summary<<EOF" >> $GITHUB_OUTPUT
            echo "$SUMMARY" >> $GITHUB_OUTPUT
            echo "EOF" >> $GITHUB_OUTPUT
          else
            echo "summary=CI failure in ${{ github.event.workflow_run.name }} on branch ${{ github.event.workflow_run.head_branch }}. Check the workflow run for details." >> $GITHUB_OUTPUT
          fi

      - name: Send Slack Notification
        uses: slackapi/slack-github-action@v2.1.1
        with:
          webhook: ${{ secrets.SLACK_WEBHOOK_URL }}
          webhook-type: incoming-webhook
          payload: |
            blocks:
              - type: "header"
                text:
                  type: "plain_text"
                  text: "ðŸ”´ CI Pipeline Failed"
                  emoji: true
              - type: "section"
                fields:
                  - type: "mrkdwn"
                    text: "*Workflow:*\n${{ github.event.workflow_run.name }}"
                  - type: "mrkdwn"
                    text: "*Branch:*\n${{ github.event.workflow_run.head_branch }}"
              - type: "section"
                text:
                  type: "mrkdwn"
                  text: "*Claude's Analysis:*\n${{ steps.read-summary.outputs.summary }}"
              - type: "actions"
                elements:
                  - type: "button"
                    text:
                      type: "plain_text"
                      text: "View Failed Run"
                      emoji: true
                    url: "${{ github.event.workflow_run.html_url }}"
                    style: "danger"
                  - type: "button"
                    text:
                      type: "plain_text"
                      text: "View Repository"
                      emoji: true
                    url: "${{ github.server_url }}/${{ github.repository }}"
